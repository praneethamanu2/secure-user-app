<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }
      .container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        width: 100%;
        max-width: 900px;
        padding: 28px;
      }
      header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
      h1 { font-size: 28px; color:#111827 }
      button { padding: 0.45rem 0.75rem; border-radius:6px; border:1px solid #CBD5E1; background:#F8FAFC; cursor:pointer }
      .token-box { background:#0f172a; color:#e6edf3; padding:0.75rem; border-radius:6px; overflow:auto }
      table { width:100%; border-collapse:collapse; margin-top:0.75rem }
      th, td { padding:8px; text-align:left; border-bottom:1px solid #eef2f7 }
      .actions button { margin-right:6px }
      .inline-input { width:80px; padding:6px; border:1px solid #ddd; border-radius:4px }
      select.inline-select { padding:6px; border-radius:4px }
      .muted { color:#6b7280 }
      .row-empty { text-align:center; color:#6b7280 }
    </style>
  </head>
    <body>
    <div class="container">
      <header>
        <h1>Dashboard</h1>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="avatarWrapper" style="position:relative">
            <img id="avatarImg" src="/static/avatar-default.svg" alt="avatar" style="width:40px;height:40px;border-radius:50%;cursor:pointer" />
            <div id="avatarMenu" style="display:none;position:absolute;right:0;top:48px;background:white;border:1px solid #ddd;padding:8px;border-radius:6px;box-shadow:0 6px 12px rgba(0,0,0,0.08)">
              <button id="menuProfile">Profile</button>
              <button id="menuLogout">Logout</button>
            </div>
          </div>
        </div>
      </header>

      <section>
        <p><strong>Signed in as:</strong> <span id="username">(not signed in)</span></p>
        <p><strong>Access token:</strong></p>
        <pre id="token" class="token-box">(none)</pre>
      </section>

      <section style="margin-top:1rem">
        <h3>Your Calculations</h3>
        <div id="statsPanel" style="margin-bottom:0.75rem">
          <strong>Summary:</strong>
          <div id="statsContent" class="muted">Loading stats...</div>
        </div>
        <div id="calculationsWrapper">
          <button id="refreshBtn">Refresh</button>
          <table id="calculationsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>A</th>
                <th>B</th>
                <th>Type</th>
                <th>Result</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="calculationsBody"></tbody>
          </table>
        </div>

        <div style="margin-top:1rem">
          <h4>Create Calculation</h4>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="inputA" class="inline-input" type="number" step="any" placeholder="a" />
            <input id="inputB" class="inline-input" type="number" step="any" placeholder="b" />
            <select id="inputType" class="inline-select">
              <option value="Add">Add</option>
              <option value="Sub">Sub</option>
              <option value="Multiply">Multiply</option>
              <option value="Divide">Divide</option>
            </select>
            <button id="createCalc">Create</button>
          </div>
          <div id="createMsg" style="margin-top:0.5rem"></div>
        </div>
      </section>
    </div>

    <script>
      function loadUser() {
        try {
          const userJson = localStorage.getItem('user');
          const token = localStorage.getItem('token');
          if (!token) {
            // not logged in, send to login
            window.location.href = '/login.html';
            return null;
          }
          const user = userJson ? JSON.parse(userJson) : null;
          document.getElementById('username').textContent = user?.email || user?.username || '(unknown)';
          document.getElementById('token').textContent = token || '(none)';
          return token;
        } catch (err) {
          console.error('loadUser error', err);
          return null;
        }
      }

      async function fetchCalculations(token) {
        const body = document.getElementById('calculationsBody');
        body.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
        try {
          const res = await fetch('/calculations', { headers: { 'Authorization': 'Bearer ' + token } });
          if (!res.ok) {
            body.innerHTML = `<tr><td colspan="7">Error: ${res.status} ${await res.text()}</td></tr>`;
            return;
          }
          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) {
            body.innerHTML = '<tr><td class="row-empty" colspan="7">No calculations</td></tr>';
            return;
          }
          body.innerHTML = data.map(c => renderRow(c)).join('');
        } catch (err) {
          body.innerHTML = `<tr><td colspan="7">Fetch error: ${err}</td></tr>`;
        }
      }

      function renderRow(c) {
        return `
          <tr id="row-${c.id}">
            <td>${c.id}</td>
            <td data-a>${c.a}</td>
            <td data-b>${c.b}</td>
            <td data-type>${c.type}</td>
            <td>${c.result ?? ''}</td>
            <td class="muted">${c.created_at}</td>
            <td class="actions">
              <button onclick="startEdit(${c.id})">Edit</button>
              <button onclick="deleteCalc(${c.id})">Delete</button>
            </td>
          </tr>
        `;
      }

      function startEdit(id) {
        const row = document.getElementById('row-' + id);
        if (!row) return;
        const a = row.querySelector('[data-a]').textContent;
        const b = row.querySelector('[data-b]').textContent;
        const type = row.querySelector('[data-type]').textContent;
        row.innerHTML = `
          <td>${id}</td>
          <td><input class="inline-input" id="edit-a-${id}" type="number" step="any" value="${a}" /></td>
          <td><input class="inline-input" id="edit-b-${id}" type="number" step="any" value="${b}" /></td>
          <td>
            <select id="edit-type-${id}" class="inline-select">
              <option value="Add" ${type==='Add'?'selected':''}>Add</option>
              <option value="Sub" ${type==='Sub'?'selected':''}>Sub</option>
              <option value="Multiply" ${type==='Multiply'?'selected':''}>Multiply</option>
              <option value="Divide" ${type==='Divide'?'selected':''}>Divide</option>
            </select>
          </td>
          <td id="edit-result-${id}"></td>
          <td class="muted">(editing)</td>
          <td class="actions">
            <button onclick="saveEdit(${id})">Save</button>
            <button onclick="cancelEdit(${id})">Cancel</button>
          </td>
        `;
      }

      async function saveEdit(id) {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login.html';
        const a = parseFloat(document.getElementById(`edit-a-${id}`).value || '0');
        const b = parseFloat(document.getElementById(`edit-b-${id}`).value || '0');
        const type = document.getElementById(`edit-type-${id}`).value;
        const resultCell = document.getElementById(`edit-result-${id}`);
        resultCell.textContent = 'Saving...';
        try {
          const res = await fetch(`/calculations/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ a, b, type })
          });
          if (!res.ok) {
            const txt = await res.text();
            resultCell.textContent = `Error: ${res.status} ${txt}`;
            return;
          }
          const updated = await res.json();
          // re-render full list to keep things simple
              fetchCalculations(token);
              fetchStats(token);
        } catch (err) {
          resultCell.textContent = 'Save error: ' + err;
        }
      }

      function cancelEdit(id) {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login.html';
        fetchCalculations(token);
      }

      async function deleteCalc(id) {
        if (!confirm('Delete calculation #' + id + '?')) return;
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login.html';
        try {
          const res = await fetch(`/calculations/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (res.status === 204) {
            fetchCalculations(token);
            fetchStats(token);
          } else {
            alert('Delete failed: ' + res.status);
          }
        } catch (err) {
          alert('Delete error: ' + err);
        }
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });

      // avatar menu
      document.getElementById('avatarImg').addEventListener('click', (e) => {
        const m = document.getElementById('avatarMenu');
        m.style.display = m.style.display === 'none' ? 'block' : 'none';
      });
      document.getElementById('menuLogout').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });
      document.getElementById('menuProfile').addEventListener('click', () => {
        window.location.href = '/profile.html';
      });

      document.getElementById('refreshBtn').addEventListener('click', () => {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login.html';
        fetchCalculations(token);
      });

      document.getElementById('createCalc').addEventListener('click', async () => {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login.html';
        const a = parseFloat(document.getElementById('inputA').value || '0');
        const b = parseFloat(document.getElementById('inputB').value || '0');
        const type = document.getElementById('inputType').value;
        const msg = document.getElementById('createMsg');
        msg.textContent = 'Creating...';
        try {
          const res = await fetch('/calculations', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ a, b, type })
          });
          if (!res.ok) {
            const txt = await res.text();
            msg.textContent = `Error: ${res.status} ${txt}`;
            return;
          }
          const created = await res.json();
          msg.textContent = 'Created âœ“';
          // refresh list
            fetchCalculations(token);
            fetchStats(token);
        } catch (err) {
          msg.textContent = 'Create error: ' + err;
        }
      });

      // initialize
      const token = loadUser();
      if (token) {
        fetchCalculations(token);
        fetchStats(token);
      }

      async function fetchStats(token) {
        const container = document.getElementById('statsContent');
        container.textContent = 'Loading stats...';
        try {
          const res = await fetch('/calculations/stats', { headers: { 'Authorization': 'Bearer ' + token } });
          if (!res.ok) {
            container.textContent = `Error: ${res.status}`;
            return;
          }
          const s = await res.json();
          container.innerHTML = `Total: <strong>${s.total_count}</strong> &middot; Avg A: <strong>${s.avg_a ?? '-'} </strong> &middot; Avg B: <strong>${s.avg_b ?? '-'} </strong> &middot; Avg Result: <strong>${s.avg_result ?? '-'}</strong>`;
        } catch (err) {
          container.textContent = 'Stats fetch error: ' + err;
        }
      }
    </script>
  </body>
</html>
