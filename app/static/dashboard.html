<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 2rem; }
      .card { border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px; max-width: 720px; }
      header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
      button { padding: 0.5rem 0.75rem; border-radius:6px; border:1px solid #CBD5E1; background:#F8FAFC; cursor:pointer }
      pre { background:#0f172a; color:#e6edf3; padding:0.75rem; border-radius:6px; overflow:auto }
    </style>
  </head>
  <body>
    <div class="card">
      <header>
        <h1>Dashboard</h1>
        <div>
          <button id="logoutBtn">Logout</button>
        </div>
      </header>

      <section>
        <p><strong>Signed in as:</strong> <span id="username">(not signed in)</span></p>
        <p><strong>Access token:</strong></p>
        <pre id="token">(none)</pre>
      </section>

      <section style="margin-top:1rem">
        <h3>Your Calculations</h3>
        <div id="calculationsWrapper">
          <button id="refreshBtn">Refresh</button>
          <table id="calculationsTable" style="width:100%; margin-top:0.75rem; border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left; padding:6px">ID</th>
                <th style="text-align:left; padding:6px">A</th>
                <th style="text-align:left; padding:6px">B</th>
                <th style="text-align:left; padding:6px">Type</th>
                <th style="text-align:left; padding:6px">Result</th>
                <th style="text-align:left; padding:6px">Created</th>
              </tr>
            </thead>
            <tbody id="calculationsBody"></tbody>
          </table>
        </div>

        <div style="margin-top:1rem">
          <h4>Create Calculation</h4>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="inputA" type="number" step="any" placeholder="a" />
            <input id="inputB" type="number" step="any" placeholder="b" />
            <select id="inputType">
              <option value="Add">Add</option>
              <option value="Sub">Sub</option>
              <option value="Multiply">Multiply</option>
              <option value="Divide">Divide</option>
            </select>
            <button id="createCalc">Create</button>
          </div>
          <div id="createMsg" style="margin-top:0.5rem"></div>
        </div>
      </section>
    </div>

    <script>
      function loadUser() {
        try {
          const userJson = localStorage.getItem('user');
          const token = localStorage.getItem('token');
          if (!token) {
            // not logged in, send to login
            window.location.href = '/login.html';
            return null;
          }
          const user = userJson ? JSON.parse(userJson) : null;
          document.getElementById('username').textContent = user?.email || user?.username || '(unknown)';
          document.getElementById('token').textContent = token || '(none)';
          return token;
        } catch (err) {
          console.error('loadUser error', err);
          return null;
        }
      }

      async function fetchCalculations(token) {
        const body = document.getElementById('calculationsBody');
        body.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        try {
          const res = await fetch('/calculations', { headers: { 'Authorization': 'Bearer ' + token } });
          if (!res.ok) {
            body.innerHTML = `<tr><td colspan="6">Error: ${res.status} ${await res.text()}</td></tr>`;
            return;
          }
          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) {
            body.innerHTML = '<tr><td colspan="6">No calculations</td></tr>';
            return;
          }
          body.innerHTML = data.map(c => `
            <tr>
              <td style="padding:6px">${c.id}</td>
              <td style="padding:6px">${c.a}</td>
              <td style="padding:6px">${c.b}</td>
              <td style="padding:6px">${c.type}</td>
              <td style="padding:6px">${c.result ?? ''}</td>
              <td style="padding:6px">${c.created_at}</td>
            </tr>
          `).join('');
        } catch (err) {
          body.innerHTML = `<tr><td colspan="6">Fetch error: ${err}</td></tr>`;
        }
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });

      document.getElementById('refreshBtn').addEventListener('click', () => {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login.html';
        fetchCalculations(token);
      });

      document.getElementById('createCalc').addEventListener('click', async () => {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login.html';
        const a = parseFloat(document.getElementById('inputA').value || '0');
        const b = parseFloat(document.getElementById('inputB').value || '0');
        const type = document.getElementById('inputType').value;
        const msg = document.getElementById('createMsg');
        msg.textContent = 'Creating...';
        try {
          const res = await fetch('/calculations', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ a, b, type })
          });
          if (!res.ok) {
            const txt = await res.text();
            msg.textContent = `Error: ${res.status} ${txt}`;
            return;
          }
          const created = await res.json();
          msg.textContent = 'Created âœ“';
          // refresh list
          fetchCalculations(token);
        } catch (err) {
          msg.textContent = 'Create error: ' + err;
        }
      });

      // initialize
      const token = loadUser();
      if (token) fetchCalculations(token);
    </script>
  </body>
</html>
