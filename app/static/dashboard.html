<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 2rem; }
      .card { border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px; max-width: 720px; }
      header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
      button { padding: 0.5rem 0.75rem; border-radius:6px; border:1px solid #CBD5E1; background:#F8FAFC; cursor:pointer }
      pre { background:#0f172a; color:#e6edf3; padding:0.75rem; border-radius:6px; overflow:auto }
    </style>
  </head>
  <body>
    <div class="card">
      <header>
        <h1>Dashboard</h1>
        <div>
          <button id="logoutBtn">Logout</button>
        </div>
      </header>

      <section>
        <p><strong>Signed in as:</strong> <span id="username">(not signed in)</span></p>
        <p><strong>Access token:</strong></p>
        <pre id="token">(none)</pre>
      </section>

      <section style="margin-top:1rem">
        <button id="fetchProtected">Fetch protected calculations</button>
        <div id="protectedResult" style="margin-top:0.75rem"></div>
      </section>
    </div>

    <script>
      function loadUser() {
        try {
          const userJson = localStorage.getItem('user');
          const token = localStorage.getItem('token');
          const user = userJson ? JSON.parse(userJson) : null;
          document.getElementById('username').textContent = user?.email || user?.username || '(unknown)';
          document.getElementById('token').textContent = token || '(none)';
        } catch (err) {
          console.error('loadUser error', err);
        }
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });

      document.getElementById('fetchProtected').addEventListener('click', async () => {
        const token = localStorage.getItem('token');
        const out = document.getElementById('protectedResult');
        if (!token) {
          out.textContent = 'No token present. Please login first.';
          return;
        }
        out.textContent = 'Loading...';
        try {
          const res = await fetch('/calculations', { headers: { 'Authorization': 'Bearer ' + token } });
          if (!res.ok) {
            out.textContent = 'Error: ' + res.status + ' ' + (await res.text());
            return;
          }
          const data = await res.json();
          out.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          out.textContent = 'Fetch error: ' + err;
        }
      });

      loadUser();
    </script>
  </body>
</html>
